<script>

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRaW-Jeexk1nvmxlUTk7TAq2akhZW8eY7OxYkgbNcDFyfcOqfyq17_L4w3xRW8cz14JWME0_Fk29hWs/pub?output=csv";

/* load csv */
fetch(CSV_URL)
.then(r=>r.text())
.then(text=>{

const lines=text.trim().split("\n").map(l=>l.split(","));

/* ========= META ========= */

const meta={};

for(let i=0;i<4;i++){
meta[lines[i][0]]=lines[i][1];
}

document.getElementById("artist").textContent=meta.artist;
document.getElementById("desc").textContent=meta.description;

/* photo everywhere */
document.querySelector(".hero").style.backgroundImage=`url(${meta.photo})`;
document.body.style.setProperty(
'--bg',
`url(${meta.photo})`
);

/* ========= BEATS ========= */

const headerIndex=lines.findIndex(r=>r[0]==="title");
const beats=lines.slice(headerIndex+1);

const container=document.getElementById("beats");

beats.forEach(row=>{

const [title,type,mp3,wav,exc,file]=row;
if(!file) return;

const beat=document.createElement("div");
beat.className="beat";

beat.innerHTML=`
<b>${title}</b><br>
<small>${type}</small>

<button class="play">▶</button>
<div class="progress"><div class="bar"></div></div>

<div class="price">
MP3 ${mp3}₽ | WAV ${wav}₽ | EXCL ${exc}₽
<button class="buy">Купить</button>
</div>
`;

container.appendChild(beat);

const audio=new Audio(file);

const play=beat.querySelector(".play");
const bar=beat.querySelector(".bar");
const prog=beat.querySelector(".progress");
const buy=beat.querySelector(".buy");

play.onclick=()=>{
if(audio.paused){
audio.play();
play.textContent="❚❚";
}else{
audio.pause();
play.textContent="▶";
}
};

audio.ontimeupdate=()=>{
bar.style.width=(audio.currentTime/audio.duration*100)+"%";
};

prog.onclick=e=>{
const rect=prog.getBoundingClientRect();
audio.currentTime=((e.clientX-rect.left)/rect.width)*audio.duration;
};

buy.onclick=()=>{
window.open(meta.buy_link,"_blank");
};

});

});

</script>
