<script>

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRaW-Jeexk1nvmxlUTk7TAq2akhZW8eY7OxYkgbNcDFyfcOqfyq17_L4w3xRW8cz14JWME0_Fk29hWs/pub?output=csv";

/* ===== DOM ===== */
const artistEl=document.getElementById("artist");
const descriptionEl=document.getElementById("description");
const heroEl=document.getElementById("hero");
const socialsEl=document.getElementById("socials");
const beatsEl=document.getElementById("beats");

/* ===== CSV PARSER ===== */
function parseCSV(text){
const rows=[];
let row=[],value="",inside=false;

for(let c of text){
if(c=='"'){inside=!inside;continue;}
if(c==","&&!inside){row.push(value.trim());value="";continue;}
if((c=="\n"||c=="\r")&&!inside){
if(value||row.length){
row.push(value.trim());
rows.push(row);
row=[];
value="";
}
continue;
}
value+=c;
}
return rows.filter(r=>r.length);
}

let currentAudio=null;

fetch(CSV_URL)
.then(r=>r.text())
.then(text=>{

const rows=parseCSV(text);

/* ===== СТРОГАЯ СХЕМА =====
0 — заголовки профиля
1 — данные профиля
2 — пусто
3 — заголовки битов
4+ — биты
*/

const profile = rows[1];
const beatsData = rows.slice(4);

/* PROFILE */

artistEl.textContent=profile[0]||"";
descriptionEl.textContent=profile[1]||"";

if(profile[2]){
heroEl.style.backgroundImage=`url(${profile[2]})`;
document.body.style.backgroundImage=`url(${profile[2]})`;
}

/* SOCIALS */

const socialsData=[
["Telegram",profile[3]],
["Instagram",profile[4]],
["YouTube",profile[5]],
["VK",profile[6]]
];

socialsEl.innerHTML="";

socialsData.forEach(s=>{
if(!s[1])return;
const a=document.createElement("a");
a.href=s[1];
a.target="_blank";
a.textContent=s[0];
socialsEl.appendChild(a);
});

const buyLink = profile[7] || "#";

/* BEATS */

beatsEl.innerHTML="";

beatsData.forEach(row=>{

if(!row[0])return;

const beat=document.createElement("div");
beat.className="beat";

beat.innerHTML=`
<div class="title">${row[0]}</div>
<div class="type">${row[1]||""}</div>

<div class="player">
<button class="play">▶</button>
<div class="progress"><div class="bar"></div></div>
</div>

<div class="price">
<span>MP3 ${row[2]||0}₽ | WAV ${row[3]||0}₽ | EXCL ${row[4]||0}₽</span>
<a class="buy" href="${buyLink}" target="_blank">Купить</a>
</div>
`;

beatsEl.appendChild(beat);

const audio=new Audio(row[5]);
const play=beat.querySelector(".play");
const bar=beat.querySelector(".bar");
const progress=beat.querySelector(".progress");

play.onclick=()=>{
if(currentAudio && currentAudio!==audio){
currentAudio.pause();
document.querySelectorAll(".play").forEach(b=>b.textContent="▶");
}

if(audio.paused){
audio.play();
play.textContent="❚❚";
currentAudio=audio;
}else{
audio.pause();
play.textContent="▶";
}
};

audio.ontimeupdate=()=>{
if(audio.duration)
bar.style.width=(audio.currentTime/audio.duration)*100+"%";
};

progress.onclick=e=>{
if(!audio.duration)return;
const r=progress.getBoundingClientRect();
audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration;
};

});

})
.catch(e=>console.error("LOAD ERROR:",e));

</script>
