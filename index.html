<script>

const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRaW-Jeexk1nvmxlUTk7TAq2akhZW8eY7OxYkgbNcDFyfcOqfyq17_L4w3xRW8cz14JWME0_Fk29hWs/pub?output=csv";

const nameEl = document.getElementById("name");
const descEl = document.getElementById("desc");
const hero = document.getElementById("hero");
const bg = document.getElementById("bg");
const socials = document.getElementById("socials");
const beats = document.getElementById("beats");

fetch(CSV_URL)
.then(r => r.text())
.then(text => {

console.log("CSV loaded");

/* AUTO DELIMITER DETECT */
const delimiter = text.includes(";") ? ";" : ",";

const rows = text
.trim()
.split("\n")
.map(r => r.split(delimiter));

console.log(rows);

/* PROFILE ROW */
const p = rows[1];

if(!p){
nameEl.textContent="Ошибка чтения таблицы";
return;
}

const name = p[0] || "";
const desc = p[1] || "";
const photo = p[2] || "";
const tg = p[3] || "";
const ig = p[4] || "";
const yt = p[5] || "";
const vk = p[6] || "";
const buy = p[7] || "#";

nameEl.textContent = name;
descEl.textContent = desc;

if(photo){
hero.style.backgroundImage=`url(${photo})`;
bg.style.backgroundImage=`url(${photo})`;
}

/* SOCIALS */

[
["Telegram", tg],
["Instagram", ig],
["YouTube", yt],
["VK", vk]
].forEach(([label, link])=>{
if(link){
const a=document.createElement("a");
a.className="social";
a.href=link;
a.target="_blank";
a.textContent=label;
socials.appendChild(a);
}
});

/* BEATS */

rows.slice(5).forEach(r=>{

if(!r[0]) return;

const div=document.createElement("div");
div.className="beat";

div.innerHTML=`
<div class="title">${r[0]}</div>
<div class="type">${r[1] || ""}</div>

<audio controls src="${r[5]}"></audio>

<div class="bottom">
<div>MP3 ${r[2]} | WAV ${r[3]} | EXCL ${r[4]}</div>
<a class="buy" href="${buy}" target="_blank">Купить</a>
</div>
`;

beats.appendChild(div);

});

})
.catch(err=>{
console.error(err);
nameEl.textContent="Ошибка загрузки CSV";
});

/* ONE PLAYER ONLY */

document.addEventListener("play",e=>{
document.querySelectorAll("audio").forEach(a=>{
if(a!==e.target)a.pause();
});
},true);

</script>
