<script>

const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRaW-Jeexk1nvmxlUTk7TAq2akhZW8eY7OxYkgbNcDFyfcOqfyq17_L4w3xRW8cz14JWME0_Fk29hWs/pub?output=csv";

/* ===== НОРМАЛЬНЫЙ CSV PARSER ===== */
function parseCSV(text){
const rows=[];
let row=[];
let value="";
let insideQuotes=false;

for(let i=0;i<text.length;i++){
const char=text[i];

if(char === '"'){
insideQuotes=!insideQuotes;
continue;
}

if(char === "," && !insideQuotes){
row.push(value);
value="";
continue;
}

if(char === "\n" && !insideQuotes){
row.push(value);
rows.push(row);
row=[];
value="";
continue;
}

value+=char;
}

return rows;
}

/* ===== LOAD ===== */

fetch(CSV_URL)
.then(r=>r.text())
.then(text=>{

const rows=parseCSV(text);

const header=rows[1];

/* PROFILE */

document.getElementById("artist").innerText=header[0];
document.getElementById("description").innerText=header[1];

document.getElementById("hero").style.backgroundImage=
`url(${header[2]})`;

const socials=[
["Telegram",header[3]],
["Instagram",header[4]],
["YouTube",header[5]],
["VK",header[6]]
];

const socialBox=document.getElementById("socials");
socialBox.innerHTML="";

socials.forEach(s=>{
if(!s[1]) return;
const a=document.createElement("a");
a.href=s[1];
a.target="_blank";
a.innerText=s[0];
socialBox.appendChild(a);
});

/* BEATS */

const container=document.getElementById("beats");
container.innerHTML="";

rows.slice(4).forEach(row=>{

if(!row[0]) return;

const beat=document.createElement("div");
beat.className="beat";

beat.innerHTML=`
<div class="title">${row[0]}</div>
<div class="type">${row[1]}</div>

<div class="player">
<button class="play">▶</button>
<div class="progress"><div class="bar"></div></div>
</div>

<div class="price">
<span>
MP3 ${row[2]}₽ | WAV ${row[3]}₽ | EXCL ${row[4]}₽
</span>
<a class="buy" href="${header[3]}" target="_blank">Купить</a>
</div>
`;

container.appendChild(beat);

const audio=new Audio(row[5]);
const play=beat.querySelector(".play");
const progress=beat.querySelector(".progress");
const bar=beat.querySelector(".bar");

play.onclick=()=>{
if(audio.paused){
audio.play();
play.innerText="❚❚";
}else{
audio.pause();
play.innerText="▶";
}
};

audio.ontimeupdate=()=>{
bar.style.width=(audio.currentTime/audio.duration)*100+"%";
};

progress.onclick=e=>{
const rect=progress.getBoundingClientRect();
audio.currentTime=
((e.clientX-rect.left)/rect.width)*audio.duration;
};

});

});

</script>
